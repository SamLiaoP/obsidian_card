name: Test API Generation

on:
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Test generate_tree.py
        run: |
          echo "ğŸ§ª æ¸¬è©¦ API ç”Ÿæˆ..."
          python3 generate_tree.py
          
      - name: Validate generated files
        run: |
          echo "ğŸ” é©—è­‰ç”Ÿæˆçš„æª”æ¡ˆ..."
          
          # æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨
          test -f index.json && echo "âœ“ index.json å·²ç”Ÿæˆ"
          test -f search.json && echo "âœ“ search.json å·²ç”Ÿæˆ"
          test -f tree.json && echo "âœ“ tree.json å·²ç”Ÿæˆ"
          test -d api/files && echo "âœ“ api/files/ ç›®éŒ„å·²å‰µå»º"
          
          # é©—è­‰ JSON æ ¼å¼
          python3 -m json.tool index.json > /dev/null && echo "âœ“ index.json æ ¼å¼æ­£ç¢º"
          python3 -m json.tool search.json > /dev/null && echo "âœ“ search.json æ ¼å¼æ­£ç¢º"
          python3 -m json.tool tree.json > /dev/null && echo "âœ“ tree.json æ ¼å¼æ­£ç¢º"
          
          # çµ±è¨ˆè³‡è¨Š
          FILE_COUNT=$(ls api/files/ | wc -l)
          echo "ğŸ“Š ç”Ÿæˆäº† $FILE_COUNT å€‹æª”æ¡ˆå…§å®¹ JSON"
          
          # æª¢æŸ¥æª”æ¡ˆå¤§å°
          INDEX_SIZE=$(ls -lh index.json | awk '{print $5}')
          SEARCH_SIZE=$(ls -lh search.json | awk '{print $5}')
          echo "ğŸ“„ index.json: $INDEX_SIZE"
          echo "ğŸ“„ search.json: $SEARCH_SIZE"
          
          echo "âœ… æ‰€æœ‰æ¸¬è©¦é€šéï¼"
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: |
            index.json
            search.json
            api/files/*.json
          retention-days: 7

