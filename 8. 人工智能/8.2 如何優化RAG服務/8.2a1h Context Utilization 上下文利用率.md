# LLM as a judge  
# Context Utilization

## Required
- User Input -> Question
- LLM Output -> Answer
- **Retrieved Contexts** -> Contexts

## 描述
**上下文利用率**（Context Utilization）評估檢索到的上下文是否能夠充分支持回答問題，並確保所有相關的內容片段被優先排名。此分數在 0 到 1 之間，分數越高代表上下文中的關鍵資訊更集中在排名靠前的位置。此評估類似於 **Context Precision**，但不依賴參考答案進行比較。

### 計算方法
1. **評估相關性**：對於檢索到的上下文中的每個片段，檢查其是否與回答問題的內容直接相關。
2. **計算 Precision@k**：針對每個片段計算精確率，即在每個排名位置 \( k \) 上的相關片段數量與總片段數之比。
3. **上下文利用率**：對所有片段的 Precision@k 取平均，得到最終的上下文利用率分數。

### 計算公式
$$
\text{Context Utilization} = \frac{1}{\text{Number of Relevant Chunks}} \sum_{k=1}^{n} \left( \frac{\text{Number of Relevant Chunks Up to Position } k}{k} \times r_k \right)
$$

其中：
- \( n \) 是上下文的總片段數。
- \( r_k \) 是第 \( k \) 個片段的相關性指標，相關片段 \( r_k = 1 \)，不相關則為 \( r_k = 0 \)。

## 程式碼
```python
from datasets import Dataset 
from ragas.metrics import context_utilization
from ragas import evaluate

# 準備數據樣本
data_samples = {
    'question': ['When was the first super bowl?', 'Who won the most super bowls?'],
    'answer': ['The first superbowl was held on Jan 15, 1967', 'The most super bowls have been won by The New England Patriots'],
    'contexts' : [['The First AFL–NFL World Championship Game was an American football game played on January 15, 1967, at the Los Angeles Memorial Coliseum in Los Angeles,'], 
    ['The Green Bay Packers...Green Bay, Wisconsin.', 'The Packers compete...Football Conference']],
}

# 創建數據集並計算上下文利用率分數
dataset = Dataset.from_dict(data_samples)
score = evaluate(dataset, metrics=[context_utilization])
print(score.to_pandas())
```

在此範例中，**上下文利用率分數**表明檢索到的上下文中相關片段的排序程度。分數越高表示回應的回答更多依賴靠前的相關資訊，有助於提高回答的準確性和完整性。